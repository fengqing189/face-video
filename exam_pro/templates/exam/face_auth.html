<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>人脸对比</title>
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">

</head>
<body>
<div class="container">
    <div class="row col-md-4 col-md-offset-4"></div>
</div>
<video id="video" width="480" height="480" controls></video>
{#<p>#}
{#    <button id="capture">拍照</button>#}
{#</p>#}
{#<canvas id="canvas" width="480" height="320"></canvas>#}

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script>
    //访问用户媒体设备的兼容方法
    function getUserMedia(constraints, success, error) {
        if (navigator.mediaDevices.getUserMedia) {
            //最新的标准API
            navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
        } else if (navigator.webkitGetUserMedia) {
            //webkit核心浏览器
            navigator.webkitGetUserMedia(constraints, success, error)
        } else if (navigator.mozGetUserMedia) {
            //firfox浏览器
            navigator.mozGetUserMedia(constraints, success, error);
        } else if (navigator.getUserMedia) {
            //旧版API
            navigator.getUserMedia(constraints, success, error);
        }
    }

    // let video = document.getElementById('video');
    // let canvas = document.getElementById('canvas');
    // let context = canvas.getContext('2d');

    function success(stream) {
        //兼容webkit核心浏览器
        let CompatibleURL = window.URL || window.webkitURL;
        //将视频流设置为video元素的源
        console.log(stream);

        //video.src = CompatibleURL.createObjectURL(stream);
        video.srcObject = stream;
        video.play();
    }

    function error(error) {
        console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
    }

    //if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
    //调用用户媒体设备, 访问摄像头
    //  getUserMedia({video: {width: 480, height: 320}}, success, error);
    //} else {
    //  alert('不支持访问用户媒体');
    //}

    //document.getElementById('capture').addEventListener('click', function () {
    //context.drawImage(video, 0, 0, 480, 320);
    //})


    var video_elemwnt = document.getElementById('video');


    navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {width: 1280, height: 720}
    }).then(function success(stream) {
        console.log(stream);
        video_elemwnt.srcObject = stream;
        video_elemwnt.play();

    }).catch(function error(err) {
        console.log(err);
    });


    var canvas = document.createElement('canvas');
    canvas.width = '400';
    canvas.height = '300';

    var ctx = canvas.getContext('2d');

    function paizhao() {

        ctx.drawImage(video_elemwnt,0,0,400,300);  //把当前视频画到canvas画布上
        img = canvas.toDataURL("image/png");   // 这里把视频流转换成，base64位
        console.log(img,'==============img');

        // 这里把获取到的base64位的信息用ajax发送到后端
        function send_ajax() {
            console.log('1111111111===ajax');
            $.ajax({
                type: 'POST',
                url: "/img/info",
                dataType: 'json',
                data: {"img_b64": img},
                success: function (msg) {
                    console.log(msg);
                },
                error: function (err) {
                    console.log(err);
                }
            });
        }

        send_ajax()

    };

    setTimeout(paizhao(),3000)


</script>
</body>


</html>